<!-- templates/auth/reset_password_confirm.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Сброс пароля — SND</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/auth.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="{% static 'js/theme-toggle.js' %}"></script>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <h1>Новый пароль</h1>
    </div>
    <form id="reset-form">
      <input type="hidden" id="token" />
      <input type="hidden" id="email" />
      <div class="input-group">
        <input type="password" id="password" placeholder=" " required />
        <label for="password">Новый пароль</label>
        <i class="icon fas fa-lock"></i>
      </div>
      <button type="submit" class="auth-btn">Сменить</button>
    </form>
    <div class="message" id="message"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const email = urlParams.get('email');
    if (!token || !email) {
      document.body.innerHTML = '<h1>Неверная ссылка</h1>';
    } else {
      document.getElementById('token').value = token;
      document.getElementById('email').value = email;
    }

    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      if (password.length < 6) {
        alert('Пароль слишком короткий');
        return;
      }
      const btn = document.querySelector('.auth-btn');
      btn.classList.add('loading');
      btn.textContent = 'Сохраняем...';

      try {
        const res = await fetch('/api/password_reset_confirm/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, email, password })
        });
        const data = await res.json();
        document.getElementById('message').textContent = data.success || data.error;
        document.getElementById('message').className = 'message show ' + (res.ok ? 'success' : 'error');
        if (res.ok) setTimeout(() => location.href = '/login/', 2000);
      } catch {
        alert('Ошибка');
      } finally {
        btn.classList.remove('loading');
        btn.textContent = 'Сменить';
      }
    });
  </script>
</body>
</html>