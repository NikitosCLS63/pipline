{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="margin-top: 20px; margin-bottom: 40px;">
    <h1 style="margin-bottom: 30px;">Избранное</h1>
    
    <div style="margin-bottom: 15px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 11px; color: #6c757d;">
      <span>Горячие клавиши: </span>
      <span style="margin-left: 8px;"><kbd style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Alt</kbd> + <kbd style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Shift</kbd> + <kbd style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 10px;">D</kbd> - Удалить из избранного</span>
    </div>
    
    <div id="favorites-container">
        {% if favorites %}
            <div class="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                {% for product in favorites %}
                    <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s;">
                        {% if product.images %}
                            {% for img in product.images %}
                                {% if forloop.first %}
                                    <img src="{{ img }}" alt="{{ product.product_name }}" style="width: 100%; height: 200px; object-fit: cover; background: #f5f5f5;" onerror="this.onerror=null; this.src='{% static 'images/no-image.png' %}'">
                                {% endif %}
                            {% empty %}
                                {% if product.image_url %}
                                    <img src="{{ product.image_url }}" alt="{{ product.product_name }}" style="width: 100%; height: 200px; object-fit: cover; background: #f5f5f5;" onerror="this.onerror=null; this.src='{% static 'images/no-image.png' %}'">
                                {% else %}
                                    <div style="width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                        <span style="color: #999;">Нет изображения</span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% elif product.image_url %}
                            <img src="{{ product.image_url }}" alt="{{ product.product_name }}" style="width: 100%; height: 200px; object-fit: cover; background: #f5f5f5;" onerror="this.onerror=null; this.src='{% static 'images/no-image.png' %}'">
                        {% else %}
                            <div style="width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999;">Нет изображения</span>
                            </div>
                        {% endif %}
                        
                        <div style="padding: 15px;">
                            <h3 style="font-size: 16px; margin: 0 0 10px 0; min-height: 40px;">{{ product.product_name }}</h3>
                            <p style="color: #666; font-size: 14px; margin: 0 0 10px 0;">SKU: {{ product.sku }}</p>
                            {% if product.price %}
                                <p style="font-size: 18px; font-weight: bold; color: #2c7a3f; margin: 0 0 10px 0;">₽{{ product.price }}</p>
                            {% endif %}
                            {% if product.stock_quantity %}
                                <p style="color: #28a745; font-size: 14px; margin: 0 0 10px 0;">✓ В наличии ({{ product.stock_quantity }})</p>
                            {% else %}
                                <p style="color: #dc3545; font-size: 14px; margin: 0 0 10px 0;">✗ Нет в наличии</p>
                            {% endif %}
                            
                            <div style="display: flex; gap: 8px; margin-top: 15px;">
                                <button class="btn" onclick="openModal('{{ product.product_id }}')" style="flex: 1; background: #2c7a3f; color: white; padding: 10px; text-align: center; border-radius: 4px; border: none; cursor: pointer; font-size: 14px;">Подробнее</button>
                                
                                <button class="btn btn-remove-wishlist" data-product-id="{{ product.product_id }}" style="flex: 1; background: #dc3545; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Удалить</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 60px 20px; background: #f9f9f9; border-radius: 8px;">
                <p style="font-size: 18px; color: #666; margin-bottom: 20px;">У вас нет избранных товаров</p>
                <a href="{% url 'catalog' %}" class="btn" style="background: #2c7a3f; color: white; padding: 12px 30px; text-decoration: none; border-radius: 4px; display: inline-block;">Перейти в каталог</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
let isLoading = false;

async function loadFavoritesFromAPI() {
    if (isLoading) return;
    
    const serverFavoritesCount = document.querySelectorAll('.product-card').length;
    if (serverFavoritesCount > 0 && document.querySelector('.products-grid') !== null) return;
    
    const token = localStorage.getItem('access_token');
    if (!token) return;
    
    isLoading = true;
    try {
        const response = await fetch('/api/wishlists/', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            const wishlists = await response.json();
            if (wishlists.length > 0) {
                const productIds = wishlists.map(w => w.product);
                await loadProductDetails(productIds, token);
            }
        }
    } catch (error) {
        console.error('Error loading wishlist:', error);
    } finally {
        isLoading = false;
    }
}

async function loadProductDetails(productIds, token) {
    const productsData = [];
    for (const id of productIds) {
        try {
            const response = await fetch(`/api/products/${id}/`, {
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });
            if (response.ok) {
                const product = await response.json();
                productsData.push(product);
            }
        } catch (error) {
            console.error('Error loading product', id, error);
        }
    }
    if (productsData.length > 0) renderFavorites(productsData);
}

function extractValidImages(images) {
    if (!images) return [];
    
    let result = [];
    
    // Если images это массив
    if (Array.isArray(images)) {
        for (let img of images) {
            if (typeof img === 'string' && img.trim() && !img.startsWith('blob:')) {
                // Проверяем, не является ли это JSON строкой
                if (img.trim().startsWith('[') || img.trim().startsWith('"')) {
                    try {
                        const parsed = JSON.parse(img.trim());
                        if (Array.isArray(parsed)) {
                            result.push(...parsed.filter(u => typeof u === 'string' && !u.startsWith('blob:')));
                        } else if (typeof parsed === 'string') {
                            result.push(parsed);
                        }
                    } catch (e) {
                        // Если не JSON, добавляем как есть
                        result.push(img.trim());
                    }
                } else {
                    result.push(img.trim());
                }
            } else if (Array.isArray(img)) {
                // Рекурсивно обрабатываем вложенные массивы
                result.push(...extractValidImages(img));
            }
        }
    } else if (typeof images === 'string') {
        // Если images это строка
        if (images.trim().startsWith('[')) {
            try {
                const parsed = JSON.parse(images.trim());
                if (Array.isArray(parsed)) {
                    result.push(...extractValidImages(parsed));
                }
            } catch (e) {
                if (!images.startsWith('blob:')) {
                    result.push(images.trim());
                }
            }
        } else if (!images.startsWith('blob:')) {
            result.push(images.trim());
        }
    }
    
    // Убираем дубликаты и пустые строки
    return result.filter((url, index, self) => 
        typeof url === 'string' && 
        url.trim() && 
        !url.startsWith('blob:') &&
        self.indexOf(url) === index
    );
}

function renderFavorites(products) {
    const container = document.getElementById('favorites-container');
    let html = '<div class="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">';
    for (const product of products) {
        // Получаем изображения из product.images или product.image_url
        let imageUrl = '/static/images/no-image.png';
        
        if (product.images && Array.isArray(product.images) && product.images.length > 0) {
            const validImages = extractValidImages(product.images);
            if (validImages.length > 0) {
                imageUrl = validImages[0];
            }
        } else if (product.images && typeof product.images === 'string') {
            try {
                const parsed = JSON.parse(product.images);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    const validImages = extractValidImages(parsed);
                    if (validImages.length > 0) {
                        imageUrl = validImages[0];
                    }
                } else {
                    imageUrl = product.images;
                }
            } catch (e) {
                imageUrl = product.images;
            }
        } else if (product.image_url) {
            imageUrl = product.image_url;
        }
        
        html += `
            <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s;">
                <img src="${imageUrl}" alt="${product.product_name}" style="width: 100%; height: 200px; object-fit: cover; background: #f5f5f5;" onerror="this.onerror=null; this.src='/static/images/no-image.png'">
                <div style="padding: 15px;">
                    <h3 style="font-size: 16px; margin: 0 0 10px 0; min-height: 40px;">${product.product_name}</h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 10px 0;">SKU: ${product.sku || 'N/A'}</p>
                    <p style="font-size: 18px; font-weight: bold; color: #2c7a3f; margin: 0 0 10px 0;">₽${product.price ? new Intl.NumberFormat('ru-RU').format(Math.round(product.price)) : 'N/A'}</p>
                    <p style="font-size: 14px; margin: 0 0 10px 0; ${product.stock_quantity ? 'color: #28a745;' : 'color: #dc3545;'}">
                        ${product.stock_quantity ? `✓ В наличии (${product.stock_quantity})` : '✗ Нет в наличии'}
                    </p>
                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button class="btn" onclick="openModal('${product.product_id}')" style="flex: 1; background: #2c7a3f; color: white; padding: 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px;">Подробнее</button>
                        <button class="btn btn-remove-wishlist" data-product-id="${product.product_id}" style="flex: 1; background: #dc3545; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Удалить</button>
                    </div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;
    attachRemoveListeners();
}

function attachRemoveListeners() {
    document.querySelectorAll('.btn-remove-wishlist').forEach(button => {
        button.removeEventListener('click', handleRemoveClick);
        button.addEventListener('click', handleRemoveClick);
    });
}

function handleRemoveClick(event) {
    event.preventDefault();
    event.stopPropagation();
    const productId = this.getAttribute('data-product-id');
    if (!productId) {
        console.error('No product_id found');
        return;
    }
    removeFromWishlist(productId, event);
}

function removeFromWishlist(productId, event) {
    const token = localStorage.getItem('access_token');
    if (!token) { 
        alert('Требуется авторизация'); 
        window.location.href = '/login/'; 
        return; 
    }

    // Конвертируем product_id в число
    const productIdNum = parseInt(productId);
    if (isNaN(productIdNum)) {
        console.error('Invalid product_id:', productId);
        alert('Ошибка: некорректный ID товара');
        return;
    }

    // Показываем индикатор загрузки
    const button = event?.target || document.querySelector(`[data-product-id="${productId}"]`);
    if (button) {
        button.disabled = true;
        button.textContent = 'Удаление...';
    }

    // Получаем CSRF токен (если есть)
    const csrftoken = getCookie('csrftoken');
    const headers = { 
        'Authorization': `Bearer ${token}`, 
        'Content-Type': 'application/json'
    };
    if (csrftoken) {
        headers['X-CSRFToken'] = csrftoken;
    }
    
    fetch('/api/wishlists/remove_from_wishlist/', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ product_id: productIdNum })
    })
    .then(async res => {
        if (res.ok) {
            const data = await res.json().catch(() => ({}));
            console.log('Successfully removed from wishlist:', data);
            // Удаляем элемент из DOM без перезагрузки страницы
            const productCard = button?.closest('.product-card');
            if (productCard) {
                productCard.style.transition = 'opacity 0.3s';
                productCard.style.opacity = '0';
                setTimeout(() => {
                    productCard.remove();
                    // Проверяем, остались ли товары
                    const remainingCards = document.querySelectorAll('.product-card');
                    if (remainingCards.length === 0) {
                        const catalogUrl = '{% url "catalog" %}';
                        document.getElementById('favorites-container').innerHTML = 
                            '<div style="text-align: center; padding: 60px 20px; background: #f9f9f9; border-radius: 8px;">' +
                            '<p style="font-size: 18px; color: #666; margin-bottom: 20px;">У вас нет избранных товаров</p>' +
                            '<a href="' + catalogUrl + '" class="btn" style="background: #2c7a3f; color: white; padding: 12px 30px; text-decoration: none; border-radius: 4px; display: inline-block;">Перейти в каталог</a>' +
                            '</div>';
                    }
                }, 300);
            } else {
                // Если не удалось найти элемент, перезагружаем страницу
                location.reload();
            }
        } else if (res.status === 401) { 
            alert('Сессия истекла. Пожалуйста, авторизуйтесь снова'); 
            window.location.href = '/login/'; 
        } else {
            const errorData = await res.json().catch(() => ({ error: 'Неизвестная ошибка' }));
            console.error('Error removing from wishlist:', res.status, errorData);
            alert(`Ошибка при удалении товара: ${errorData.error || errorData.message || 'Неизвестная ошибка'}`);
            if (button) {
                button.disabled = false;
                button.textContent = 'Удалить';
            }
        }
    })
    .catch(err => { 
        console.error('Network error removing from wishlist:', err); 
        alert('Ошибка соединения. Проверьте подключение к интернету'); 
        if (button) {
            button.disabled = false;
            button.textContent = 'Удалить';
        }
    });
}

function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (const cookie of cookies) {
        const c = cookie.trim();
        if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
    }
    return null;
}

// Привязываем обработчики для серверных товаров (Django template)
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем избранное из API, если нужно
    loadFavoritesFromAPI();
    
    // Привязываем обработчики для товаров, которые уже загружены сервером
    attachRemoveListeners();
});

function openModal(productId) {
    window.location.href = `/catalog/?product=${productId}#open-modal`;
}

// Горячие клавиши для удаления из избранного
document.addEventListener('keydown', function(e) {
    const isInput = e.target.tagName === 'INPUT' || 
                   e.target.tagName === 'TEXTAREA' || 
                   e.target.isContentEditable;
    
    if (isInput) return;
    
    // Alt + Shift + D - Удалить первый товар из избранного
    if (e.altKey && e.shiftKey && e.key.toLowerCase() === 'd') {
        e.preventDefault();
        const removeButtons = document.querySelectorAll('.btn-remove-wishlist');
        if (removeButtons.length > 0) {
            const firstButton = removeButtons[0];
            const productId = firstButton.getAttribute('data-product-id');
            if (productId) {
                removeFromWishlist(productId, { target: firstButton });
            }
        }
    }
});
</script>
{% endblock %}
